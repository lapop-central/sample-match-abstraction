---
title: "draw_sample"
author: "Maita Schade"
date: "Aug 8, 2019"
output: html_notebook
---

Make sure we're dealing with a clear space:
```{r}
rm(list = ls(all = TRUE))
```
  
Set the following chunk depending on the circumstances:
```{r}
country = "AR"
strats = c("GEO1_AR2010")

datadir = paste0('C:/Users/schadem/Box Sync/LAPOP Shared/working documents/maita/Coordination/IDB Online/Matching process/Data/',country,'/')

censuspath <- paste0(datadir,'sample/', country,'_ipums_recoded.csv')

recodepath <- paste0("C:/Users/schadem/Box Sync/LAPOP Shared/working documents/maita/Analysis/Sample match abstraction/matching_COUNTRY/recode_Netquest_IPUMS_",country, ".csv")
```

```{r}
library(data.table)
library(devtools)
#install.packages('devtools')
#install_github("maitagorri/sampleMatch")
library(sampleMatch)
install.packages('bit64')
```

Reading in the sampling data and making necessary updates.

Here, we are using the IPUMS data.
```{r}
census<- fread(censuspath, drop='V1')
head(census)
```


Try stratified sampling.

```{r}
n <- 1200
set.seed(11111)
target  <- strat_weight_sample(census.proc,strats,'PERWT',n)
```

Making sure this stratification worked...
```{r}
barplot(table( target[[strat1]]))
nrow(target)
head(target)
```

Add a sample id, counting those that occur more than once:
```{r}
target$SAMPCT<-1
multis <- unique(target[duplicated(target$censusId),'censusId'])
for (i in multis){
    target[target$censusId==i,'SAMPCT':=1:table(target$censusId)[i]]
}

target$sampleId <- paste0(
  target$censusId,
  sprintf(
    paste0('%0',
           as.character(max(nchar(target$SAMPCT))),
           '.0f'),
    target$SAMPCT)
)

```


Dice just the variables needed for matching
```{r}
recode_map <- fread(recodepath)
matching.vars <- unique(recode_map$common_var)
target <- target[,c("sampleId",matching.vars),with=F]
```


Write to disk
```{r}
names(target)
write.csv(x=target,
          file = paste0(datadir,
                        "sample/",
                        country,
                        "_target_",
                        format(Sys.time(), 
                               "%Y%m%d"),
                        ".csv")
                    )

```
