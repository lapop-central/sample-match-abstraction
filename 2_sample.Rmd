---
title: "draw_sample"
author: "Maita Schade"
date: "Aug 8, 2019"
output: html_notebook
---

Make sure we're dealing with a clear space:
```{r}
rm(list = ls(all = TRUE))
```
  
Set the following chunk depending on the circumstances:
```{r}
country = "AR"
```

Defining files--make sure the dirs are okay; other than that you shouldn't need to touch this if the file structure is set up properly.
```{r}
datadir = paste0('C:/Users/schadem/Box Sync/LAPOP Shared/working documents/maita/Coordination/IDB Online/Matching process/Data/',country,'/')

censuspath <- paste0(datadir,'sample/', country,'_ipums_recoded.csv')

recodepath <- paste0("./recode_Netquest_IPUMS_",country, ".csv")
parampath <- "./country_parameters.csv" # set specific parametrs in this file
prior_target_path <- 'C:/Users/schadem/Box Sync/LAPOP Shared/working documents/maita/Coordination/IDB Online/Matching process/Data/AR/panel/AR_selected_wave1_190613.csv'
```

```{r}
library(data.table)
library(devtools)
#install.packages('devtools')
#install_github("maitagorri/sampleMatch")
library(sampleMatch)
```

Load country-specific parameters:
```{r}
params <- fread(parampath,key = "country")[country,]
strats <- unlist(Filter(f = Negate(is.na), params[,c("strat1","strat2")]))
```


Reading in the sampling data and making necessary updates.

Here, we are using the IPUMS data.
```{r}
census<- fread(censuspath, colClasses = c(censusId="character")) #keep it simple, and keep leading 0s
head(census)

```


Try stratified sampling.

```{r}
n <- 1200
set.seed(121988)
target  <- strat_weight_sample(census,strats,'PERWT',n)
```

This chunk just for testing multi-appearances of censusIds
```{r}
# while(nrow(multis)!=0){
#   target  <- strat_weight_sample(census,strats,'PERWT',n)
#   multis <- unique(target[duplicated(target$censusId),'censusId'])
# }
```

Making sure this stratification worked...
```{r}
barplot(table( target[[strats[1]]]))
nrow(target)
head(target)
hist(target$age)
hist(census$age)
table(target$age,target$gend)
```

Add a sample id, counting those that occur more than once:
```{r}
target$SAMPCT<-1
multis <- unique(target[duplicated(target$censusId),'censusId'])

for (i in multis){
  print(i)
  target[target$censusId==i,'SAMPCT':=1:table(target$censusId)[i]]
}
table(target$SAMPCT) # check that the sampcounts are right

target$sampleId <- paste0(
  target$censusId,
  sprintf(
    paste0('%0',
           as.character(max(nchar(target$SAMPCT))),
           '.0f'),
    target$SAMPCT)
)
head(target)
```


Dice just the variables needed for matching
```{r}
recode_map <- fread(recodepath)
matching.vars <- unique(recode_map$common_var)
target <- target[,c("sampleId",matching.vars),with=F]
```

Since we just re-defined the geographies to departments again, let's make sure the new and improved target is exactly the same as the previous, except for X and Y.

Load previous target:
```{r}
target.old <- fread(paste0(datadir, "sample/AR_target_20190909_province.csv"),colClasses = c(sampleId="character"))
#target.other <- fread(paste0(datadir, "/sample/AR_target_190912_province.csv"),colClasses = c(sampleId="character"))

```
Look at both:
```{r}
#sum(target.other$sampleId%in%target.old$sampleId)
```
Note that this doesn't work. We'll need to re-fit the old sample with the new data.
It seems I used the 1909 census target all along; hopefully nothing else big changed...

Re-engineer censusId:
```{r}
max(nchar(census$censusId))
max(nchar(target.old$sampleId))
# max(nchar(target$sampleId))
target.old$censusId <- substr(target.old$sampleId,1,12)
table(nchar(target.old$censusId))
table(nchar(target.old$sampleId))

```
Use censusId to replace X,Y in target.old
```{r}
target.new <- merge(target.old[,grep("X|Y",names(target.old),invert=T,value = T),with=F],
      census[,c("censusId","X","Y"),with=F], by="censusId")
sum(!target.new$sampleId%in%target.old$sampleId)
dim(target.new)
sum(!target.old$censusId%in%census$censusId)
target.old[!censusId%in%census$censusId,]
census[X==-58.44888,]
```

Write target with new geography to disk
```{r}
names(target.new)
write.csv(x=target.new,
          file = paste0(datadir,
                        "sample/",
                        country,
                        "_target_",
                        # format(Sys.time(), 
                               # "%y%m%d"),
                        "20190909",
                        ".csv"),
          row.names = F
                    )

```
